<!doctype html>

<html lang="en">
<head>
    <meta charset="utf-8">

    <title>List UI</title><style type="text/css">body{
margin:40px auto;
max-width:650px;
line-height:1.6;
font-size:18px;
color:#eee;
background-color:#111;
padding:0 10px
}
textarea, input, button {
color:#eee;
background-color:#111;
}
</style>
</head>

<body>
    <div>
        <form id="fileForm">
            <label for="fileInput">Choose a list file:</label>
            <input type="file" id="fileInput" name="fileInput" />
        </form>
    </div>
    <div id="outputDiv">
        
    </div>
    <script>
        const fileForm = document.getElementById("fileForm");
        // We aren't allowed to reload the file automatically without user input
        // apparently, so reset the form to make that clearer.
        fileForm.reset();
        
        const fileInput = document.getElementById("fileInput");
        const outputDiv = document.getElementById("outputDiv");
        
        fileInput.addEventListener("change", () => {
            for (let i = 0; i < fileInput.files.length; i += 1) {
                const file = fileInput.files[i];
                
                const reader = new FileReader();

                reader.onload = (e) => {
                    // The content of the file as a text string
                    const fileContent = e.target.result + "\n"; // We add "\n" So we know we'll flush the last item
                    
                    //
                    //  Parse The List
                    //
                    
                    const STATE_INITIAL = 0;
                    const STATE_HEADER = 1;
                    const STATE_LIST_ITEM = 2;
                    
                    let state = STATE_INITIAL;
                    let tempHeader = "";
                    let tempListItem = "";
                    let headers = {};
                    
                    for (const c of fileContent) {
                        switch (state) {
                            case STATE_INITIAL:
                                switch (c) {
                                    case "#":
                                        state = STATE_HEADER;
                                        tempHeader = "";
                                    break;
                                    default:
                                        console.log("unhandled:" + c)
                                    break;
                                }
                            break;
                            case STATE_HEADER:
                                switch (c) {
                                    case "\n":
                                        tempHeader = tempHeader.trim()

                                        if (tempHeader) {
                                            state = STATE_LIST_ITEM;
                                            // TODO? Bother to handle identical headers?
                                            headers[tempHeader] = [];
                                            tempListItem = "";
                                        } else {
                                            state = STATE_INITIAL;
                                            tempHeader = "";
                                            tempListItem = "";
                                        }
                                    break;
                                    default:
                                        tempHeader += c;
                                    break
                                }
                            break;
                            case STATE_LIST_ITEM:
                                switch (c) {
                                    case "#":
                                        state = STATE_HEADER;
                                        if (tempListItem) {
                                            headers[tempHeader].push(tempListItem);
                                        }
                                        tempHeader = "";
                                    break;
                                    case "\n":
                                        tempListItem = tempListItem.trim()

                                        if (tempListItem) {
                                            // TODO handle sub items properly. Support infinite levels?
                                            headers[tempHeader].push({ name: tempListItem, subItems: []});
                                        }
                                        tempListItem = "";
                                    break;
                                    default:
                                        tempListItem += c;
                                    break;
                                }
                            break;
                        }
                    }
                    
                    //
                    //  Display the Parsed List
                    //
                    
                    for (const headerName of Object.keys(headers)) {
                        const headerElem = document.createElement('h3');
                        headerElem.innerText = headerName;
                        outputDiv.appendChild(headerElem);
                        
                        const items = headers[headerName];
                        
                        for (const item of items) {
                            const itemElem = document.createElement('p');
                            itemElem.innerText = item.name;
                            outputDiv.appendChild(itemElem);
                            
                            for (const subItem of item.subItems) {
                                const subItemElem = document.createElement('p');
                                subItemElem.innerText = item.subItems.name;
                                outputDiv.appendChild(subItem);
                            }
                        }
                    }
                };

                reader.readAsText(file);
            }
        });
    </script>
</body>
</html>
